<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BeautyHub | Upload Skincare</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root { --brand:#ff6b6b; --line:#e6e6e6; --ink:#222; --muted:#666; --bg:#f7f7f7; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: Arial, Helvetica, sans-serif; background:var(--bg); color:var(--ink);}
  header { background:#fff; border-bottom:1px solid var(--line); }
  .wrap { max-width:1100px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:16px; }
  .logo { font-weight:700; color:var(--brand); font-size:22px; }
  .nav a { text-decoration:none; color:var(--muted); margin-left:16px; }
  main { max-width:1100px; margin:24px auto 60px; padding:0 16px; display:grid; grid-template-columns: 2fr 1fr; gap:24px; }
  @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
  .card { background:#fff; border:1px solid var(--line); border-radius:10px; }
  .card .head { padding:16px; border-bottom:1px solid var(--line); font-weight:700; }
  .card .body { padding:16px; }

  /* Uploader */
  .drop { border:2px dashed var(--line); border-radius:12px; padding:24px; text-align:center; background:#fff; cursor:pointer; }
  .drop.drag { border-color: var(--brand); background:#fff4f4; }
  .drop input { display:none; }
  .thumbs { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:12px; margin-top:16px; }
  .thumb { position:relative; border:1px solid var(--line); border-radius:8px; overflow:hidden; background:#fafafa; }
  .thumb img { width:100%; height:120px; object-fit:cover; display:block; }
  .thumb .label { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,.55); color:#fff; font-size:12px; padding:4px 6px; }

  /* Results */
  .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; margin:6px 6px 0 0; background:#fff; }
  .pill input { border:none; outline:none; font:inherit; width:240px; }
  .pill button { border:none; background:transparent; color:#b00; cursor:pointer; font-size:16px; }
  .row { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
  .btn { background:var(--brand); color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#333; }
  .note { color:var(--muted); font-size:12px; margin-top:6px; }
  .prog { height:8px; background:#eee; border-radius:999px; overflow:hidden; margin-top:10px; display:none; }
  .bar { height:100%; width:0%; background:var(--brand); transition:width .2s; }
  textarea { width:100%; min-height:140px; border:1px solid var(--line); border-radius:8px; padding:10px; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="logo">BeautyHub</div>
    <div class="nav" style="margin-left:auto">
      <a href="index.html">Home</a>
      <a href="cart.html">Cart</a>
    </div>
  </div>
</header>

<main>
  <!-- Left: Uploader -->
  <section class="card">
    <div class="head">Upload skincare photo(s)</div>
    <div class="body">
      <label class="drop" id="drop">
        <input id="file" type="file" accept="image/*" multiple />
        <div>Click to choose images or drag & drop here</div>
        <div class="note">Tips: good lighting, flat labels, crop to product.</div>
        <div class="prog" id="prog"><div class="bar" id="bar"></div></div>
      </label>
      <div class="thumbs" id="thumbs"></div>

      <div class="row">
        <button class="btn" id="run">Read products</button>
        <button class="btn secondary" id="clear">Clear images</button>
      </div>
      <div class="note" id="status"></div>
    </div>
  </section>

  <!-- Right: Extracted products -->
  <section class="card">
    <div class="head">Detected products</div>
    <div class="body">
      <div id="pills"></div>
      <div class="row">
        <button class="btn" id="copyList">Copy list</button>
        <button class="btn secondary" id="saveLocal">Save to device (JSON)</button>
      </div>
      <div class="note">You can edit any item. Remove with “×”.</div>

      <h4 style="margin-top:18px">Raw OCR text (optional)</h4>
      <textarea id="raw" placeholder="Raw text will appear here…"></textarea>
    </div>
  </section>
</main>

<!-- Tesseract.js via CDN (runs OCR in-browser) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
  // ---- State ----
  const state = { files: [], products: [] };
  const LS_KEY = 'beautyhub_detected_products';

  // ---- DOM ----
  const fileInp = document.getElementById('file');
  const drop = document.getElementById('drop');
  const thumbs = document.getElementById('thumbs');
  const runBtn = document.getElementById('run');
  const clearBtn = document.getElementById('clear');
  const pillsBox = document.getElementById('pills');
  const rawBox = document.getElementById('raw');
  const status = document.getElementById('status');
  const prog = document.getElementById('prog');
  const bar = document.getElementById('bar');
  const copyBtn = document.getElementById('copyList');
  const saveBtn = document.getElementById('saveLocal');

  // ---- Uploader ----
  const addFiles = (files) => {
    for (const f of files) {
      if (!f.type.startsWith('image/')) continue;
      state.files.push(f);
      const url = URL.createObjectURL(f);
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `<img src="${url}" alt=""><div class="label">${f.name}</div>`;
      thumbs.appendChild(div);
    }
    if (state.files.length) status.textContent = `${state.files.length} image(s) ready.`;
  };

  fileInp.addEventListener('change', e => addFiles(e.target.files));
  ;['dragenter','dragover'].forEach(evt=> drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.add('drag'); }));
  ;['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.remove('drag'); }));
  drop.addEventListener('drop', e => addFiles(e.dataTransfer.files));

  clearBtn.addEventListener('click', ()=>{
    state.files = [];
    thumbs.innerHTML = '';
    status.textContent = 'Cleared.';
  });

  // ---- OCR ----
  function progress(p){ 
    prog.style.display = 'block'; 
    bar.style.width = `${Math.round((p||0)*100)}%`;
  }

  function normalizeLine(s){
    // Clean spacing, remove extra symbols
    return s.replace(/\s+/g,' ').replace(/[|_*~•]+/g,'').trim();
  }

  function isLikelyProduct(line){
    // Heuristics: medium length, contains letters, not just one word like "INGREDIENTS"
    if (!line) return false;
    if (line.length < 4 || line.length > 80) return false;
    if (!/[a-zA-Z]/.test(line)) return false;
    const blacklist = ['INGREDIENTS','DIRECTIONS','WARNING','CAUTION','USAGE','NET WT','FL OZ','ML','MADE IN','DISTRIBUTED BY','EXP','LOT','SCAN','BARCODE','CRUELTY FREE','VEGAN','SUNSCREEN','SPF ONLY'];
    if (blacklist.some(w => line.toUpperCase().includes(w))) return false;
    // Often product names contain brand + descriptor words
    const words = line.split(' ');
    const alphas = words.filter(w => /[a-zA-Z]/.test(w));
    return alphas.length >= 2;
  }

  function titleCase(s){
    return s.toLowerCase().replace(/\b([a-z])/g, m => m.toUpperCase());
  }

  function dedupe(arr){
    const seen = new Set();
    const out = [];
    for(const s of arr){
      const key = s.toLowerCase();
      if (!seen.has(key)) { seen.add(key); out.push(s); }
    }
    return out;
  }

  async function ocrFile(file, i, total){
    const worker = await Tesseract.createWorker('eng', 1);
    const { data } = await worker.recognize(file, { logger: m => {
      if (m.status === 'recognizing text' && m.progress != null){
        // progress across all files
        const base = (i/total);
        const pct = base + (m.progress/total);
        progress(pct);
      }
    }});
    await worker.terminate();
    return data.text || '';
  }

  runBtn.addEventListener('click', async ()=>{
    if (!state.files.length){ alert('Add at least one image.'); return; }
    status.textContent = 'Running OCR…';
    progress(0);

    let allText = '';
    state.products = [];

    for (let i=0;i<state.files.length;i++){
      const txt = await ocrFile(state.files[i], i, state.files.length);
      allText += '\n' + txt;
      // quick parse per image
      const lines = txt.split(/\r?\n/).map(normalizeLine).filter(Boolean);
      const candidates = lines.filter(isLikelyProduct).map(titleCase);
      state.products.push(...candidates);
    }

    // Post-process
    const unique = dedupe(state.products).slice(0, 200); // cap
    state.products = unique;
    rawBox.value = allText.trim();

    renderPills();
    status.textContent = `Found ${state.products.length} product line(s). Review and edit if needed.`;
    progress(1);
    setTimeout(()=>{ prog.style.display = 'none'; }, 600);
  });

  // ---- Pills UI ----
  function renderPills(){
    pillsBox.innerHTML = '';
    state.products.forEach((name, idx)=>{
      const pill = document.createElement('div');
      pill.className = 'pill';
      pill.innerHTML = `<input value="${name}"/><button title="Remove">×</button>`;
      const input = pill.querySelector('input');
      const btn = pill.querySelector('button');
      input.addEventListener('input', e => state.products[idx] = e.target.value);
      btn.addEventListener('click', ()=>{
        state.products.splice(idx,1);
        renderPills();
      });
      pillsBox.appendChild(pill);
    });
    if (!state.products.length){
      pillsBox.innerHTML = '<div class="note">No products yet.</div>';
    }
  }

  // ---- Export / Copy ----
  copyBtn.addEventListener('click', async ()=>{
    const list = state.products.filter(Boolean).join('\n');
    if (!list){ alert('Nothing to copy.'); return; }
    await navigator.clipboard.writeText(list);
    alert('Copied product list to clipboard.');
  });

  saveBtn.addEventListener('click', ()=>{
    const data = state.products.filter(Boolean);
    if (!data.length){ alert('Nothing to save.'); return; }
    localStorage.setItem(LS_KEY, JSON.stringify(data));
    const blob = new Blob([JSON.stringify({ products: data }, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'beautyhub_products.json';
    a.click();
  });
</script>
</body>
</html>
